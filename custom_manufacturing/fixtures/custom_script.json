[
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Quotation",
  "modified": "2018-07-16 16:32:04.243165",
  "name": "Quotation-Client",
  "script": "frappe.ui.form.on(\"Quotation\", \"refresh\", function(frm) {\n\t//allow for joined_items only the same quotation items and with the same master_item:\n\tfrm.fields_dict['items'].grid.get_field('joined_item').get_query = function(frm, cdt, cdn) {\n\t\tvar child = locals[cdt][cdn];\n\t\treturn{\n\t\t\tfilters: {\n\t\t\t\t'parent': child.parent,\n\t\t\t\t'master_item': child.master_item,\n\t\t\t}\n\t\t}\n\t},\n\t//show only boms of choosen item:\n\tfrm.fields_dict['master_bom'].grid.get_field('bom').get_query = function(frm, cdt, cdn) {\n\t\tvar child = locals[cdt][cdn];\n\t\treturn{\n\t\t\tfilters: {\n\t\t\t\t'item': child.item,\n\t\t\t\t'type':[\"=\", \"Register\"]\n\t\t\t}\n\t\t}\n\t}\n\t//show only items that are products:\n\tfrm.fields_dict['master_bom'].grid.get_field('item').get_query= function(doc, cdt, cdn) {\n\t\treturn{\n\t\t\tfilters:[\n\t\t\t\t['Item', 'item_group', 'in', ['Products']]\n\t\t\t]\n\t\t}\n\t}\n});\n\n//read (append) items from BOM into Quotation Items:\nfrappe.ui.form.on(\"Quotation Master BOM\", {\n \"get_items\" : function(cur_frm, cdt, cdn) {\n\t\t//console.log(frm);\n\t\t//console.log(cdn);\n\t\t//console.log(cdt);\n\t\tcur_frm.doc.last_master_bom_get_items = cdn;\n\t\t//cur_frm.set_value(last_master_bom_get_items, \"cdn\");\n\t\t//console.log(cur_frm);\n\t\t\n\t\tvar bom_name = cur_frm.fields_dict['master_bom'].grid.grid_rows_by_docname[cdn].doc.bom;\n\t\tvar master_qty = cur_frm.fields_dict['master_bom'].grid.grid_rows_by_docname[cdn].doc.qty;\n\t\tif(bom_name && master_qty){\n\t\t\terpnext.utils.map_current_doc({\n\t\t\t\tmethod: \"custom_manufacturing.utils.make_quotation_from_bom\",\n\t\t\t\tsource_name: bom_name\n\t\t\t\t//source_doctype: \"BOM\",\n\t\t\t\t//target: cur_frm.doc,\n\t\t\t\t//date_field: \"posting_date\",\n\t\t\t\t//setters: {\n\t\t\t\t//\titem: 'Jumts - M\u0101ja' || undefined,\n\t\t\t\t//},\n\t\t\t\t//get_query_filters: {\n\t\t\t\t//\tdocstatus: 1\n\t\t\t\t//}\n\t\t\t}),\n\t\t\tcur_frm.save();\n\t\t}else{\n\t\t\tfrappe.msgprint(__('No BOM or qty'));\n\t\t}\n\t},\n\t\"color_picker\" : function(cur_frm, cdt, cdn) {\n\t}\n});\n\nfrappe.ui.form.on(\"Quotation\", {\n\trefresh: function(frm) {\n\t\t\tfrm.add_custom_button(__('BOM'), function() {\n\t\t\t\terpnext.utils.map_current_doc({\n\t\t\t\t\tmethod: \"custom_manufacturing.utils.make_quotation_from_bom\",\n\t\t\t\t\tsource_doctype: \"BOM\",\n\t\t\t\t\ttarget: frm,\n\t\t\t\t\tdate_field: \"posting_date\",\n\t\t\t\t\tsetters: {\n\t\t\t\t\t\tproject: frm.doc.project || undefined,\n\t\t\t\t\t},\n\t\t\t\t\tget_query_filters: {\n\t\t\t\t\t\tdocstatus: 1\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t}, __(\"Get Items From\"));\n\t}, \n});\n\n//calculate external markups:\nfrappe.ui.form.on(\"Quotation\", \"refresh\", function(frm) { //, cdt, cdn\n\t//get embedded_in values for quotation's country (do it once not for each Quotation Item)\n\t//use Promise to have data in client before doing anything else:\n\tnew Promise(resolve => frappe.call({\n\t    method: 'frappe.client.get_list',\n\t    args: {\n\t        'doctype': 'Embedded In Percent By Country',\n\t        'filters': {'country': 'Sweden'},\n\t        'fields': [\n\t            'material_embedded_in_type',\n\t            'percent',\n\t        ]\n\t    },\n\t\tcallback: resolve\n\t})).then(r => {\n\t\tvar embedded_in_values  = r.message;\n\t\tconsole.log('embedded_in_values');\n\t\tconsole.log(embedded_in_values);\n\t\t//color rows in master table and item table; color name is saved into items or master items doctype field 'color_picker'\n\t\t$.each(cur_frm.doc.master_bom || [], function(i, b) {\t\n\t\t\t\t$(\"div[data-name='\"+b.name+\"']\").find('div.data-row > div.grid-static-col').css({'background-color': b.color_picker});\n\t\t});\n\t\n\t\t//calc for each 'Quoatation Item' markups:\n\t\t$.each(cur_frm.doc.items || [], function(i, d) {\n\n\t\t\t\t$(\"div[data-name='\"+d.name+\"']\").find('div.data-row > div.grid-static-col').css({'background-color': d.color_picker});\n\t\t\n\t\t\t\t//unset margin rate??!!!\n\t\t\t\t//frappe.model.set_value(d.doctype, d.name, \"margin_rate_or_amount\", \"0.00\");\n\n\t\t\t\tvar rate = d.price_list_rate;\n\t\t\t\t//if is set material_embedded_in - R, R/O, O, R, D... then get its default percent value:\n\t\t\t\tif(d.material_embedded_in && embedded_in_values){\n\n\t\t\t\t\tvar material_embedded_in_markup_percent= $.grep(embedded_in_values, function (embedded) { return embedded.material_embedded_in_type == d.material_embedded_in })[0]['percent'];\n\t\t\t\t\tconsole.log('material_embedded_in_markup_percent:');\n\t\t\t\t\tconsole.log(material_embedded_in_markup_percent);\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\td.material_embedded_in_markup = material_embedded_in_markup_percent;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tif(d.material_embedded_in_markup){\n\t\t\t\t\tvar material_embedded_in_markup = 0.00;\n\t\t\t\t\tmaterial_embedded_in_markup = flt(d.material_embedded_in_markup)/100 * flt(rate) - flt(rate);\n\t\t\t\t\tmaterial_embedded_in_markup = material_embedded_in_markup.toFixed(2);\n\t\t\t\t\tfrappe.model.set_value(d.doctype, d.name, \"material_embedded_in_markup_amount\", material_embedded_in_markup);\n\t\t\t\t}\n\t\t\t\tif(d.factory_markup){\t\n\t\t\t\t\tvar factory_markup = 0.00;\t\t\n\t\t\t\t\tfactory_markup = flt(d.factory_markup)/100 * flt(rate) - flt(rate);\n\t\t\t\t\tfactory_markup = factory_markup.toFixed(2);\n\t\t\t\t\tfrappe.model.set_value(d.doctype, d.name, \"factory_markup_amount\", factory_markup);\n\t\t\t\t}\n\n\t\t\t\tif(d.construction_markup){\n\t\t\t\t\tvar construction_markup = 0.00;\t\t\n\t\t\t\t\tconstruction_markup = flt(d.construction_markup)/100 * flt(rate) - flt(rate);\n\t\t\t\t\tconstruction_markup = construction_markup.toFixed(2);\n\t\t\t\t\tfrappe.model.set_value(d.doctype, d.name, \"construction_markup_amount\", construction_markup);\n\t\t\t\t}\n\n\t\t\t\tif(d.delivery_markup){\n\t\t\t\t\tvar delivery_markup = 0.00;\n\t\t\t\t\tdelivery_markup = flt(d.delivery_markup)/100 * flt(rate) - flt(rate);\n\t\t\t\t\tdelivery_markup = delivery_markup.toFixed(2);\n\t\t\t\t\tfrappe.model.set_value(d.doctype, d.name, \"delivery_markup_amount\", delivery_markup);\t\t\t\t\n\t\t\t\t}\n\t\t\t\n\t\t\t\tvar markup_rate = flt(material_embedded_in_markup) + flt(factory_markup) + flt(construction_markup) + flt(delivery_markup);\n\t\t\t\t/*\n\t\t\t\tconsole.log(\"material_embedded_in_markup: \"+material_embedded_in_markup);\n\t\t\t\tconsole.log(\"factory_markup: \"+factory_markup);\n\t\t\t\tconsole.log(\"construction_markup: \"+construction_markup);\n\t\t\t\tconsole.log(\"delivery_markup: \"+delivery_markup);\n\n\t\t\t\tconsole.log(\"rate before: \" + rate);\t\t\t\n\t\t\t\tconsole.log(\"marku rate after: \"+markup_rate);\t\n\t\t\t\t*/\t\n\t\t\t\tfrappe.model.set_value(d.doctype, d.name, \"margin_type\", \"Amount\");\n\t\t\t\tfrappe.model.set_value(d.doctype, d.name, \"margin_rate_or_amount\", markup_rate);\n\t\t\t\t//console.log(\"rate after in reality: \"+d.rate);\t\t\t\n\t\t\t\t//console.log(material_embedded_in_markup);\n\t\t\t\t//console.log(rate);\n\t\t});\t//end of calc for each 'Quoatation Item' markups\n\t}); //end of Promise then\n\t\n})\n\n//create 'production' BOMs from quoatations:\nfrappe.ui.form.on(\"Quotation\", \"create_boms\", function(frm, cdt, cdn) {\n\tconsole.log(\"Quotation creating boms2\");\n\tfrappe.call({\n\t\t\tmethod: \"custom_manufacturing.utils.make_boms_from_quotations\",\n\t\t\targs: { \n\t\t\t\t\"quotation\": cur_frm.doc.name, \n\t\t\t},\n\t\t\tcallback: function(r) {\n\t\t\t\tconsole.log(r);\n\t\t\t}\n\t\t});\n\t\t\n\n});\n\n/* Not working if childtable childtable? https://discuss.erpnext.com/t/not-able-to-update-value-in-child-table-solved/16590/9\nfrappe.ui.form.on('Quotation Item', 'joined_item', function(frm, cdt, cdn){\n    console.log('inside q item');\n    var child = locals[cdt][cdn];\n\tconsole.log(child.joined_item);\n\t\n    frappe.call({\n        'method': 'frappe.client.get_value',\n        'args': {\n            'doctype': 'Item',\n\t\t\tfilters: {\n\t\t\t\t'item_code': child.joined_item,\n\t\t\t},\n           'fieldname':'name'\n        },\n        'callback': function(res){\n\t\tconsole.log(res);\n\t\tconsole.log(cdt);\n\t\tconsole.log(cdn);\n            frappe.mode.set_value('Quotation Item','QUOD/00417', 'joined_item_name', '1111');\n        }\n    });\n\t\n});\n*/\n\ncur_frm.add_fetch(\"joined_item\", \"item_code\", \"joined_item_name\");",
  "script_type": "Client"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Quotation Item",
  "modified": "2018-07-13 17:56:34.621795",
  "name": "Quotation Item-Client",
  "script": "//cur_frm.add_fetch(\"joined_item\", \"item_code\", \"joined_item_name\");\nfrappe.ui.form.on('Quotation Item', 'joined_item', function(frm, cdt, cdn){\n    console.log('inside q item');\n    frappe.call({\n        'method': 'frappe.client.get_value',\n        'args': {\n            'doctype': 'Item',\n            'filters': [\n                ['Item', 'item_code', '=', locals[cdt][cdn].joined_item]\n            ],\n           'fieldname':'name'\n        },\n        'callback': function(res){\n            frappe.mode.set_value(cdt, cdn, 'joined_item_name', res.message.name);\n        }\n    });\n});",
  "script_type": "Client"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Project Offer",
  "modified": "2018-08-02 17:12:29.693257",
  "name": "Project Offer-Client",
  "script": "cur_frm.add_fetch(\"agent\", \"employee_name\", \"agent_full_name\");\ncur_frm.add_fetch(\"agent\", \"cell_number\", \"agent_phone\");\ncur_frm.add_fetch(\"agent\", \"company_email\", \"agent_email\");\ncur_frm.add_fetch(\"agent\", \"current_address\", \"agent_city_country\");\n\ncur_frm.add_fetch(\"customer\", \"customer_primary_contact\", \"customer_full_name\");\ncur_frm.add_fetch(\"customer\", \"mobile_no\", \"customer_phone\");\ncur_frm.add_fetch(\"customer\", \"email_id\", \"customer_email\");\ncur_frm.add_fetch(\"customer\", \"primary_address\", \"customer_address\");\ncur_frm.add_fetch(\"customer\", \"customer_primary_contact\", \"authorized_signatory_customer_label\");",
  "script_type": "Client"
 }
]